#!/bin/python3
# -*- coding: utf-8 -*- 
import os
import json
import time
import argparse
import configparser
import datetime
import shutil
import re
import subprocess

################### argparser #######################
#buildfile = GEM 5의 빌드파일
#configfile = GEM 5의 구성파일
#optionfile = GEM 5실행시 옵션값파일

parser = argparse.ArgumentParser(description='GEM5 script')
parser.add_argument('-f', '--optionfile', action='store', dest='optionfile', help='ALL Option file')
parser.add_argument('-d', '--desc', action='store', dest='desc', help='GEM5 Description')
parser.add_argument('-i', '--gem5id', action='store', dest='gem5id', help='specify a simulation id for re-run')
parser.add_argument('-w', '--waittime', action='store', dest='waittime', help='specify a wiat time before running simulation')
parser.add_argument('-a', '--addfile', action='store', dest='addfile', help='additional files to be saved')

args = parser.parse_args()


config = configparser.ConfigParser()
config.optionxform = str
config.read(args.optionfile)
#########################################################

date=datetime.datetime.now().strftime("%m-%d-%y")
time_h_m=datetime.datetime.now().strftime("%H:%M")

gem5_id=""

if args.gem5id == None:
    gem5_id=str(int(time.time()*1000))
else:
    gem5_id=str(args.gem5id)

wait_time=args.waittime

########Setup simulation parameters ######################
PWD = os.getcwd()
OUTPUT_DIR=PWD+"/out/"+date
MAXMEM = 4*1024

########### Create Output directory #######################
if os.path.exists(OUTPUT_DIR)==False:
    print("Create " + OUTPUT_DIR)
    os.mkdir(OUTPUT_DIR)
    os.system("chmod g+w " + OUTPUT_DIR)

################벤치마크 금회차 설정########################

history_file=PWD+"/history.json"
description=""
if args.gem5id == None:
    print("\nBatch simulation")
    print("Date: " +date)
    print("Time: " +time_h_m)
    print("Simulaiton ID: "+str(gem5_id))
    print("Simulation History File: "+history_file)

    if args.desc == None:
        description=input("Description?: ")
    else:
        description=args.desc
    #print(description)

    print("Output directory: "+OUTPUT_DIR)
else:
    print("rerun gem5id: "+str(gem5_id))

########### Crate Detail Ouotput Directory ####################

OUTPUT_DIR=PWD+"/out/"+date+"/"+description

if os.path.exists(OUTPUT_DIR)==False:
    print("Create " + OUTPUT_DIR)
    os.mkdir(OUTPUT_DIR)
    os.system("chmod g+w " + OUTPUT_DIR)

shutil.copy2(args.optionfile, OUTPUT_DIR+"/"+str(gem5_id)+"-"+str(args.optionfile))
if args.addfile != None : 
    print(args.addfile)
    shutil.copy2(args.addfile, OUTPUT_DIR+"/"+str(gem5_id)+"-addfile-"+str(args.addfile).split('/')[-1])


################빌드 및 구성 파일 옵션 설정 ####################

def AddOption(tag) : 
    parm=""
    options=config.options(tag)
    for option_name in options:
        option_value = config.get(tag,option_name)
        if option_value == "" : 
            parm = parm + " "+ option_name
        else : 
            parm = parm + " "+ option_name + "=" + option_value
    return parm

gem5_build_option = ""
gem5_config_option = ""
output_post_fix = ""

gem5_config_option = AddOption("CONFIGOPT")



output_post_fix = gem5_id + '.'

gem5_build_file=config.get("TRACE","BUILDFILE").split('\n')
gem5_config_file=config.get("TRACE","CONFIGFILE").split('\n')
bench_build_dir=config.get("TRACE","BENCHDIR").split('\n')
#print(gem5_build_file[0])
#print(gem5_config_file[0])

########################## 실행 #############################

def RunBench(tag) : 
    bench_pwd=config.options(tag)
    for i in range(len(bench_pwd)) : 
        cmd=""
        gem5_build_option = ""
        bench_option = config.get(tag,bench_pwd[i])
        outdir = "--outdir=" + OUTPUT_DIR
        gem5_build_option = outdir + " --stats-file="+ gem5_id +"-"+str(bench_pwd[i]) + ".result"
        stdout_file = gem5_id + "-" + str(bench_pwd[i]) + ".out"
        stderr_file = gem5_id + "-" + str(bench_pwd[i]) + ".err"
        if bench_option == None : 
            cmd = gem5_build_file[0] + " " \
            + gem5_build_option + " " \
            + gem5_config_file[0] + " " \
            + gem5_config_option + " " \
            + "--cmd='" + bench_pwd[i] + "' "\
            + " > " +OUTPUT_DIR +"/"+ stdout_file \
            + " 2> " +OUTPUT_DIR + "/" + stderr_file
        else : 
            cmd = gem5_build_file[0] + " " \
            + gem5_build_option + " " \
            + gem5_config_file[0] + " " \
            + gem5_config_option + " " \
            + "--cmd='" + bench_pwd[i] + "' "\
            + "--options=" + "'" + bench_option + "'" \
            + " > " +OUTPUT_DIR +"/" + stdout_file \
            + " 2> " +OUTPUT_DIR + "/" + stderr_file
        print(cmd)
        #os.system(cmd)
        wd = os.getcwd()
        os.chdir(bench_build_dir[0] + bench_pwd[i])
        #os.system(cmd)
        subprocess.Popen(cmd,shell=True)
        os.chdir(wd)
        time.sleep(0.1)
    


RunBench("BENCHMARK")

###############history 추가##################

data= {}
if os.path.exists(history_file)==True:
    with open(history_file,'r') as json_file:
         data=json.load(json_file)
else:
    data['log']=[]

data['log'].append({
    'id': gem5_id,
    'date': date,
    'time': time_h_m,
    #'benchmarks':all_benchmark,
    #'options':all_option,
    'description':description
    })
with open(history_file,"w") as json_file:
    json.dump(data, json_file, indent="\t")
